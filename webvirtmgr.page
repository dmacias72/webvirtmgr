Icon="webvirtmgr.png"
Menu="NetworkServices"
Title="KVM Manager"
---
<?php include '/usr/local/emhttp/plugins/webvirtmgr/webvirtmgr.css';?>
<?PHP
# -------------------------------------------------------------------------
## Load current config file and check if program is installed already
# -------------------------------------------------------------------------

# This will clean any ^M characters caused by windows from the config file before use
if (file_exists("/boot/config/plugins/webvirtmgr/webvirtmgr.cfg"))
	shell_exec("sed -i 's!\r!!g' '/boot/config/plugins/webvirtmgr/webvirtmgr.cfg'");

$webvirtmgr_cfg = parse_ini_file( "/boot/config/plugins/webvirtmgr/webvirtmgr.cfg" );
$webvirtmgr_installed = file_exists( $webvirtmgr_cfg["INSTALLDIR"] . "/manage.py" ) ? "yes" : "no";

# -------------------------------------------------------------------------
## Collect local variables from config files and verify data as best as possible
# -------------------------------------------------------------------------

# Service Status Variable
if (isset($webvirtmgr_cfg['SERVICE']) && ($webvirtmgr_cfg['SERVICE'] == "enable" || $webvirtmgr_cfg['SERVICE'] == "disable"))
	$webvirtmgr_service = $webvirtmgr_cfg['SERVICE'];
else
	$webvirtmgr_service = "disable";

# Install Directory Variable
if (isset($webvirtmgr_cfg['INSTALLDIR']))
	$webvirtmgr_installdir = $webvirtmgr_cfg['INSTALLDIR'];
else
	$webvirtmgr_installdir = "/usr/local/webvirtmgr";

# Port Number Variable
if (isset($webvirtmgr_cfg['PORT']) && is_numeric($webvirtmgr_cfg['PORT'])) {
	$webvirtmgr_port = $webvirtmgr_cfg['PORT'];
	if ($webvirtmgr_port < 0 || $webvirtmgr_port > 65535)
		$webvirtmgr_port = "8000";
} else {
	$webvirtmgr_port = "8000";
}

# Run As User Variable
if (isset($webvirtmgr_cfg['RUNAS']))
	$webvirtmgr_runas = $webvirtmgr_cfg['RUNAS'];
else
	$webvirtmgr_runas = "nobody";

# Username Check Status Variable
if (isset($webvirtmgr_cfg['USERNAME']))
	$webvirtmgr_username = $webvirtmgr_cfg['USERNAME'];
else
	$webvirtmgr_username = "";

# Password Check Status Variable
if (isset($webvirtmgr_cfg['PASSWORD']))
	$webvirtmgr_password = $webvirtmgr_cfg['PASSWORD'];
else
	$webvirtmgr_password = "";

# Show Web Virtual Manager Display Variable
if (isset($webvirtmgr_cfg['SHOWDISPLAY']) && ($webvirtmgr_cfg['SHOWDISPLAY'] == "yes" || $webvirtmgr_cfg['SHOWDISPLAY'] == "no"))
	$webvirtmgr_showdisplay = $webvirtmgr_cfg['SHOWDISPLAY'];
else
	$webvirtmgr_showdisplay = "yes";


# -------------------------------------------------------------------------
## Check is program is installed and running to get extra information
# -------------------------------------------------------------------------
if ($webvirtmgr_installed=="yes") {
	$webvirtmgr_pids = shell_exec ("pgrep -f manage.py" );
	if ($webvirtmgr_pids == "")
		$webvirtmgr_running = "no";
	else
		$webvirtmgr_running = "yes";
	if ($webvirtmgr_running == "yes")
		$webvirtmgr_updatestatus = "Running";
	else
		$webvirtmgr_updatestatus = "Stopped";

	$webvirtmgr_storagesize = shell_exec ( "/etc/rc.d/rc.webvirtmgr storagesize" );
	$webvirtmgr_datacheck = shell_exec ( "/etc/rc.d/rc.webvirtmgr datacheck" );

	# Get online status of the program
	$webvirtmgr_gitmsg = shell_exec ( "git --git-dir=$webvirtmgr_installdir/.git --work-tree=$webvirtmgr_installdir status --untracked-files=no | grep  \"commits\" | sed -e 's/^# Your branch/WebVirtMgr/'" );
	if ($webvirtmgr_gitmsg == "")
		$webvirtmgr_gitstatus = "current";
	else
		$webvirtmgr_gitstatus = "update";

	# Get current installed version of the program
	$webvirtmgr_curversion = trim ( shell_exec ( "git --git-dir=$webvirtmgr_installdir/.git --work-tree=$webvirtmgr_installdir describe --tags" ) );
	if ($webvirtmgr_curversion == "")
		$webvirtmgr_curversion = "couldn't determine the WebVirtMgr version";

	# Get usernames from webvirtmgr database 
	$webvirtmgr_database = rtrim ( shell_exec ( "sqlite3 $webvirtmgr_installdir/webvirtmgr.sqlite3 'select username from auth_user' | awk '{printf \"%s,\",$1,$2 }'" ) , "," );
	if ($webvirtmgr_database != "") 	
		$webvirtmgr_userarray = explode ( "," , "$webvirtmgr_database" );
}
?>
<div style="width: 49%; float:left">
	<div id="title">
		<span class="left">Status:&#32;
			<?if ($webvirtmgr_installed=="yes"):?>
				<?if ($webvirtmgr_running=="yes"):?>
					<a href="http://<?=gethostname();?>:<?=$webvirtmgr_port;?>" target="_blank">
						<span class="green"><b>RUNNING</b></span>
					</a>
					<span style="font-size:12px;"> with version: <b><?=$webvirtmgr_curversion?></b></span>
				<?else:?>
					<span class="red"><b>STOPPED</b></span>
				<?endif;?>
			<?else:?>
				<span class="red"><b>NOT INSTALLED</b></span>
			<?endif;?>  
		</span>
	</div>  
	<?if ($webvirtmgr_installed=="yes"):?>
		<?if ($webvirtmgr_running=="yes"):?>
			<div style="position:relative;float:left;width:50%;text-align:right; margin-bottom:24px">
				<form name="webvirtmgr_start_stop" method="POST" action="/plugins/webGui/exec.php" target="progressFrame">
					<input type="hidden" name="command" value="/etc/rc.d/rc.webvirtmgr stop  ">
					<input type="submit" value="Stop">
				</form>
			</div>
			<div style="position:relative;float:left;width:50%;margin-bottom:24px">
				<form name="webvirtmgr_restart" method="POST" action="/plugins/webGui/exec.php" target="progressFrame">
					<input type="hidden" name="command" value="/etc/rc.d/rc.webvirtmgr restart  ">
					<input type="submit" value="Restart">
				</form>
			</div>
		<?else:?>
			<div style="position:relative;float:left;width:100%;text-align:center;margin-bottom:24px">
				<form name="webvirtmgr_start" method="POST" action="/plugins/webGui/exec.php" target="progressFrame">
					<input type="hidden" name="command" value="/etc/rc.d/rc.webvirtmgr buttonstart  ">
					<input type="submit" value="Start">
				</form>
			</div>
		<?endif;?>
	<?else:?>
		<div style="position:relative;float:left;width:100%;text-align:center;margin-bottom:24px">
			<form name="webvirtmgr_install" method="POST" action="/plugins/webGui/exec.php" target="progressFrame">
				<input type="hidden" name="command" value="/etc/rc.d/rc.webvirtmgr install  ">          
				<input type="submit" value="Install">
			</form>
		</div>
	<?endif;?>
	<div id="title">
		<span class="left">Information:&#32;</span>
	</div>
	<? if ($webvirtmgr_installed=="yes"): ?>  
		<? if ($webvirtmgr_gitstatus=="update"): ?>  
			<p style="color:DarkOrange;margin-left:10px;margin-right:10px;"><?=$webvirtmgr_gitmsg?></p>
			<div style="position:relative;float:left;width:100%;text-align:center;margin-bottom:24px">
				<form name="webvirtmgr_update" method="POST" action="/plugins/webGui/exec.php" target="progressFrame">
					<input type="hidden" name="command" value="/etc/rc.d/rc.webvirtmgr update <?=$webvirtmgr_updatestatus?>">          
					<input type="submit" value="Update">
				</form>
			</div>
		<?else:?>
			<p style="color:green;margin-left:10px;margin-right:10px;">Web Virtual Manager is up to date.</p>
		<? endif; ?>
		<?=$webvirtmgr_storagesize?>
		<?=$webvirtmgr_datacheck?>
	<? endif; ?>
</div>


<div style="width: 49%; float:right">
	<div id="title">
		<span class="left">Configuration:&#32;</span>
	</div>
	<form name="webvirtmgr_settings" method="POST" action="/plugins/webGui/exec.php" target="progressFrame">
		<input type="hidden" name="command" value="/etc/rc.d/rc.webvirtmgr">
		<table class="settings">
			<tr>
				<td>Enable WebVirtMgr:
					<input type="checkbox" name="enable" <?=($webvirtmgr_service=="enable")?"checked=\"checked\"":"";?> onChange="checkENABLE(this.form);">
					<input type="hidden" name="arg1" value="<?=$webvirtmgr_service;?>">     
				</td>
				<td><b>Enable Login Display:</b>
					<input type="checkbox" name="showdisplay" <?=($webvirtmgr_showdisplay=="yes")?"checked=\"checked\"":"";?> onChange="checkDISPLAY(this.form);">
					<input type="hidden" name="arg4" value="<?=$webvirtmgr_showdisplay;?>">     
				</td>

			</tr>
			<tr>
				<td>Install directory:</td>
				<td><input type="text" name="arg2" maxlength="60" value="<?=$webvirtmgr_installdir;?>" placeholder="ie. /mnt/cache/appdata for persistent data"></td>
			</tr>
			<tr>
				<td>Port:</td>
				<td><input type="text" name="arg3" maxlength="40" value="<?=$webvirtmgr_port;?>" placeholder="Default Port is 8000"></td>
			</tr>
			<tr>
				<td>Run as User:</td>
					<td><select name="runas" size="1" onChange="checkUSER(this.form);">
						<?=mk_option($webvirtmgr_runas, "nobody", "nobody");?>
						<?=mk_option($webvirtmgr_runas, "root", "root");?>
						<option value='other' <?=($webvirtmgr_runas != "root" && $webvirtmgr_runas != "nobody") ? "selected=yes":"";?>>other</option>
					</select>
					<input type="hidden" name="arg5" style="width:66%" maxlength="40" value="<?=$webvirtmgr_runas;?>">
				</td>
			</tr>
			<tr><td colspan="2"><div style="background-color:#FFFFFF;border:1px solid #000000;height:1px;width:100%;font-size:8px;"> </div></td></tr>
		<?if ($webvirtmgr_installed=="yes"):?>
			<tr>
					<td>Username:</td>
					<td>
					<select name="username" id="UsernameSelect" size="1" onChange="checkUSERNAME(this.form);">
						<option value="new" >new</option>
						<?php

						foreach ($webvirtmgr_userarray as $webvirtmgr_username)
						{
						echo "<option value = $webvirtmgr_username>$webvirtmgr_username</option>";
						}
						?>
					</select>
					<input type="text" name="arg6" style="width:68%" maxlength="40" value="" placeholder = "Enter New User">
					<input type="hidden" name="arg8" value="create">
					</td>
			</tr>
			<tr>
					<td>Password:</td>
					<td>
						<input type="password" name="arg7" value="" placeholder = "Enter Password for New User">
					</td>
			</tr>
		<? endif; ?>
		</table>
		<div align="center">
			<input type="submit" value="Apply" style="margin-bottom:8px" onClick="verifyDATA(this.form);">
			<button type="button" style="margin-bottom:35px" onClick="done();">Done</button>
		</div>
	</form>
</div>
<?if ($webvirtmgr_showdisplay=="yes"):?>
	<?if ($webvirtmgr_installed=="yes"):?>
		<?if ($webvirtmgr_running=="yes"):?>
			<div  id="webvirtmgrdisplay" style="width: 100%; float:left">
				<table>
					<tr><td colspan="2"><div style="background-color:#FFFFFF;border:1px solid #000000;height:1px;width:100%;font-size:8px;"> </div></td></tr>
					<tr><td><iframe src="http://<?=gethostname();?>:<?=$webvirtmgr_port;?>" name="webvirtmgr" width="950" height="750" frameBorder="0"></iframe></td></tr>
				</table>
			</div>
		<? endif; ?>
	<? endif; ?>
<? endif; ?>

<script type="text/javascript">
function checkRUNNING(form) {
	if ("<?=$webvirtmgr_running;?>" == "yes")
	{
		form.arg2.readOnly = true;
		form.arg3.readOnly = true;
		form.arg4.readOnly = true;
		form.arg5.readOnly = true;
		form.arg6.readOnly = true;
		form.arg7.readOnly = true;
		form.arg8.readOnly = true;
		form.runas.disabled = true;
   } 
   else
   {
		form.arg2.readOnly = (form.arg1.value == "enable");
		form.arg3.readOnly = (form.arg1.value == "enable");
		form.arg4.readOnly = (form.arg1.value == "enable");
		form.arg5.readOnly = (form.arg1.value == "enable");
		form.arg6.readOnly = (form.arg1.value == "enable");
		form.arg7.readOnly = (form.arg1.value == "enable");
		form.arg8.readOnly = (form.arg1.value == "enable");
		form.runas.disabled = (form.arg1.value == "enable");
   }
}
 
function checkUSER(form) {
	if (form.runas.selectedIndex < 2 ) {
		form.arg5.value = form.runas.options[form.runas.selectedIndex].value;
		form.arg5.type = "hidden";
	} else {
		form.arg5.value = "<?=$webvirtmgr_runas;?>";
		form.arg5.type = "text";
		form.arg5.placeholder = "Enter Run As User";
	}
}

function checkUSERNAME(form) {
	if (form.username.selectedIndex < 1 ) {
		form.arg6.value = "";
		form.arg6.type = "text";
		form.arg6.placeholder = "Enter New User";
		form.arg7.placeholder = "Enter Password for New User";
		form.arg8.value = "create";

	} else {
		form.arg6.value = form.username.options[form.username.selectedIndex].value;
		form.arg6.type = "hidden";
		form.arg7.placeholder = "Enter New Password for Selected User";
		form.arg8.value = "change";
	}
}

function verifyDATA(form) {
	if (form.arg2.value == null || !(/\S/.test(form.arg2.value))){
		form.arg2.value = "/usr/local/webvirtmgr";
	}
	if (isNumber(form.arg3.value)){
		if (form.arg3.value < 0 || form.arg3.value > 65535){
			form.arg3.value = "8000";
		}
	} else {
		form.arg3.value = "8000";
	}
	if (form.arg4.value == ""){
		form.arg4.value = "yes";
	}
	if (form.arg5.value == ""){
		form.arg5.value = "nobody";
	}
	if (form.arg6.value == ""){
		form.arg6.value = "";
	}
	if (form.arg7.value == ""){
		form.arg7.value = "";
	}
	if (form.arg8.value == ""){
		form.arg8.value = "";
	}
	form.arg1.value = form.arg1.value.replace(/ /g,"_");
	form.arg2.value = form.arg2.value.replace(/ /g,"_");
	form.arg3.value = form.arg3.value.replace(/ /g,"_");
	form.arg4.value = form.arg4.value.replace(/ /g,"_");
	form.arg5.value = form.arg5.value.replace(/ /g,"_");
	form.arg6.value = form.arg6.value.replace(/ /g,"_");
	form.arg7.value = form.arg7.value.replace(/ /g,"_");
	form.arg8.value = form.arg8.value.replace(/ /g,"_");
}

function checkENABLE(form) {
	if (form.enable.checked == false ) {
		form.arg1.value = "disable";
	} else {
		form.arg1.value = "enable";
	}
}


function checkDISPLAY(form) {
	if (form.showdisplay.checked == false ) {
		form.arg4.value = "no";
	} else {
		form.arg4.value = "yes";
	}
}

checkUSER(document.webvirtmgr_settings);
checkUSERNAME(document.webvirtmgr_settings);
checkENABLE(document.webvirtmgr_settings);
checkDISPLAY(document.webvirtmgr_settings);
</script>
